<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ReactCNN</title>
    <script src="lib\\d3.v3.min.js" charset="utf-8"></script>
</head>
<body>
</body>
<script>
    var width = 1350;
    var height = 700;
    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    var liner = d3.scale.linear().domain([0, 1])
        .range([0, 1]);
    var colorA = d3.rgb(0, 255, 255);//(10, 207, 254);//(0, 255, 255);
    var colorB = d3.rgb(0, 0, 255);//(73, 90, 255);//(0, 0, 255);
    var computeColor = d3.interpolate(colorA, colorB);

    var image = svg.append("image")
        .attr("x", 0)
        .attr("y", 231)
        .attr("width", 50)
        .attr("height", 50);

    var innersvg = svg.append("svg")
        .attr("x", 70)
        .attr("y", 384)
        .attr("width", 256)
        .attr("height", 256);

    for (var j = 0; j < 13; j++) {
        // layer[j]._layer.forEach(function (d) { d.j = j; alert(j); })
        svg.append("g").attr("id", "g"+j);
    }

    var categories = ["airplane", "automobile", "bird", "cat", "deer", "dog", "frog", "horse", "ship", "truck"]
    var textg = svg.append("g").attr("id", "g13");
    for (var i = 0; i < 10; i++) {
        textg.append("text").attr("id", "t"+i)
            .attr("x", 80 * 13 + 60)
            .attr("y", i * 45 + 55)
            .attr("font-size", "25px");
    }

    var count = 0;
    window.setInterval("timer()", 2000);
    var timer = function () {
        count++;

        d3.json("..\\reactcnn-backend\\therm.json", function (error, data) {
            if (error) throw error;
            var therm = data.therm;

            d3.json("..\\reactcnn-backend\\survey_example_"+count+".json", function (error, data) {
                if (error) {
                    count--;
                    throw error;
                }
                image.attr("xlink:href", "..\\reactcnn-backend\\image_"+count+".png");
                var layer = data.layer;
                for (var j = 0; j < layer.length; j++) {
                    // layer[j]._layer.forEach(function (d) { d.j = j; alert(j); })
                    var g = svg.selectAll("#g"+j);
                    g.selectAll("rect")
                        .data(layer[j]._layer)
                        .enter()
                        .append("rect")
                        .attr("x", function (d, i) {
                            return (i % 8 + 1) * 8 + 80 * j + 60;
                        })
                        .attr("y", function (d, i) {
                            return (Math.floor(i / 8)) * 8 + 256 - (layer[j]._layer.length / 2);
                        })
                        .attr("width", 7)
                        .attr("height", 7);

                    g.selectAll("rect")
                        .data(layer[j]._layer)
                        .attr("fill", function (d) {
                            if (d < 0) {
                                var color = computeColor(liner(0));
                            }
                            else if (d > 1) {
                                var color = computeColor(liner(1));
                            }
                            else {
                                var color = computeColor(liner(d));
                            }
                            return color.toString();
                        })
                        .attr("s", function (d) {
                            return d;
                        })
                        .attr("j", j)
                        .on("mouseover", function (d, i) {
                            var m = d3.select(this).attr("j");
                            var thermdata = innersvg.selectAll("rect").data(therm[m]._therm[i].__therm);
                            thermdata.enter()
                                .append("rect")
                                .attr("x", function (d, k) {
                                    // return (k % (Math.sqrt(therm[j][i].length)) + 1) * 8;
                                    // console.log(Math.sqrt(therm[m]._therm[i].__therm.length));
                                    return (k % (Math.sqrt(therm[m]._therm[i].__therm.length)) + 1) * 8;
                                })
                                .attr("y", function (d, k) {
                                    // return (Math.floor(k / (Math.sqrt(therm[j][i].length)))) * 8;
                                    return (Math.floor(k / (Math.sqrt(therm[m]._therm[i].__therm.length)))) * 8;
                                })
                                .attr("width", 7)
                                .attr("height", 7)
                                .attr("fill", function (d) {
                                    if(d < 0) {
                                        var color = computeColor(liner(0));
                                    }
                                    else if(d > 1) {
                                        var color = computeColor(liner(1));
                                    }
                                    else {
                                        var color = computeColor(liner(d));
                                    }
                                    return color.toString();
                                });
                            thermdata.exit().remove();
                        })
                        .on("mouseout", function (d, i) {
                            innersvg.selectAll("rect").remove();
                        });
                }

                var textg = svg.select("#g13");
                for (var i = 0; i < 10; i++) {
                    textg.select("#t"+i)
                        .attr("fill", function () {
                            return i == data.label ? "#ff0000" : "#000000";
                        })
                        .text(data.probs[i] + " " + categories[i]);
                }
            });
        });
    }
</script>
</html>